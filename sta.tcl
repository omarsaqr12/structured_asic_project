#!/usr/bin/env tclsh
#
# sta.tcl - Generic STA script for OpenROAD
# Member B - Task 2: Static Timing Analysis Script
#
# This script performs signoff timing analysis using OpenROAD/OpenSTA.
# Uses environment variables for configuration.
#
# Usage:
#   export DESIGN_NAME=6502
#   export BUILD_DIR=build
#   export LIBERTY_FILE=fabric/fabric.lib
#   export SDC_FILE=sdc/6502.sdc
#   openroad -exit sta.tcl
#

# ============================================================================
# Configuration from Environment Variables
# ============================================================================

# Design name (required)
if {![info exists ::env(DESIGN_NAME)]} {
    puts "ERROR: DESIGN_NAME environment variable not set"
    puts "Usage: export DESIGN_NAME=6502"
    exit 1
}
set design_name $::env(DESIGN_NAME)

# Build directory (default: "build")
if {![info exists ::env(BUILD_DIR)]} {
    set build_dir "build"
} else {
    set build_dir $::env(BUILD_DIR)
}

# Liberty file (required)
if {![info exists ::env(LIBERTY_FILE)]} {
    puts "ERROR: LIBERTY_FILE environment variable not set"
    puts "Usage: export LIBERTY_FILE=fabric/fabric.lib"
    exit 1
}
set liberty_file $::env(LIBERTY_FILE)

# SDC file (optional, can infer from design_name)
if {![info exists ::env(SDC_FILE)]} {
    set sdc_file "sdc/${design_name}.sdc"
} else {
    set sdc_file $::env(SDC_FILE)
}

# ============================================================================
# File Paths
# ============================================================================

set verilog_file "${build_dir}/${design_name}/${design_name}_renamed.v"
set def_file "${build_dir}/${design_name}/${design_name}_routed.def"
set spef_file "${build_dir}/${design_name}/${design_name}.spef"

# Output report files
set setup_report "${build_dir}/${design_name}/${design_name}_setup.rpt"
set hold_report "${build_dir}/${design_name}/${design_name}_hold.rpt"
set clock_skew_report "${build_dir}/${design_name}/${design_name}_clock_skew.rpt"

# ============================================================================
# Main STA Flow
# ============================================================================

puts "============================================================"
puts "Static Timing Analysis (STA) for ${design_name}"
puts "============================================================"
puts ""
puts "Configuration:"
puts "  Design Name:    ${design_name}"
puts "  Build Directory: ${build_dir}"
puts "  Liberty File:   ${liberty_file}"
puts "  SDC File:       ${sdc_file}"
puts ""

# ============================================================================
# Step 1: Read Liberty File
# ============================================================================

puts "Step 1: Reading Liberty file..."
puts "  File: ${liberty_file}"

if {![file exists ${liberty_file}]} {
    puts "ERROR: Liberty file not found: ${liberty_file}"
    exit 1
}

read_liberty ${liberty_file}

puts "  ✓ Liberty file loaded"
puts ""

# ============================================================================
# Step 2: Read Verilog Netlist
# ============================================================================

puts "Step 2: Reading Verilog netlist..."
puts "  File: ${verilog_file}"

if {![file exists ${verilog_file}]} {
    puts "ERROR: Verilog file not found: ${verilog_file}"
    exit 1
}

read_verilog ${verilog_file}

# Link design (creates the network)
link_design ${design_name}

puts "  ✓ Verilog netlist loaded and linked"
puts ""

# ============================================================================
# Step 3: Read DEF File (if available, for physical information)
# ============================================================================

puts "Step 3: Reading DEF file (if available)..."
puts "  File: ${def_file}"

if {[file exists ${def_file}]} {
    read_def ${def_file}
    puts "  ✓ DEF file loaded"
} else {
    puts "  ⚠ DEF file not found (optional, continuing without physical info)"
}

puts ""

# ============================================================================
# Step 4: Read SPEF File (Parasitic Extraction)
# ============================================================================

puts "Step 4: Reading SPEF file (parasitic extraction)..."
puts "  File: ${spef_file}"

if {![file exists ${spef_file}]} {
    puts "  ⚠ WARNING: SPEF file not found: ${spef_file}"
    puts "  This file will be generated by Member C after routing."
    puts "  STA will run without parasitic information (pre-route timing)."
    puts ""
} else {
    read_spef ${spef_file}
    puts "  ✓ SPEF file loaded"
    puts ""
}

# ============================================================================
# Step 5: Read SDC Constraints
# ============================================================================

puts "Step 5: Reading SDC constraints..."
puts "  File: ${sdc_file}"

if {![file exists ${sdc_file}]} {
    puts "  ⚠ WARNING: SDC file not found: ${sdc_file}"
    puts "  Continuing without timing constraints (results may be incomplete)"
    puts ""
} else {
    read_sdc ${sdc_file}
    puts "  ✓ SDC constraints loaded"
    puts ""
}

# ============================================================================
# Step 6: Update Timing
# ============================================================================

puts "Step 6: Updating timing..."
update_timing -full

puts "  ✓ Timing updated"
puts ""

# ============================================================================
# Step 7: Generate Setup Timing Report
# ============================================================================

puts "Step 7: Generating setup timing report..."
puts "  Report: ${setup_report}"
puts "  Number of paths: 100 (worst)"

# Create output directory if it doesn't exist
file mkdir [file dirname ${setup_report}]

# Generate setup timing report (worst 100 paths)
report_timing -setup -nworst 100 -file ${setup_report}

puts "  ✓ Setup timing report generated"
puts ""

# ============================================================================
# Step 8: Generate Hold Timing Report
# ============================================================================

puts "Step 8: Generating hold timing report..."
puts "  Report: ${hold_report}"
puts "  Number of paths: 100 (worst)"

# Generate hold timing report (worst 100 paths)
report_timing -hold -nworst 100 -file ${hold_report}

puts "  ✓ Hold timing report generated"
puts ""

# ============================================================================
# Step 9: Generate Clock Skew Report
# ============================================================================

puts "Step 9: Generating clock skew report..."
puts "  Report: ${clock_skew_report}"

# Generate clock skew report
report_clock_skew -file ${clock_skew_report}

puts "  ✓ Clock skew report generated"
puts ""

# ============================================================================
# Final Summary
# ============================================================================

puts "============================================================"
puts "STA Analysis Complete"
puts "============================================================"
puts ""
puts "Generated Reports:"
puts "  Setup Timing:    ${setup_report}"
puts "  Hold Timing:     ${hold_report}"
puts "  Clock Skew:      ${clock_skew_report}"
puts ""
puts "To view reports:"
puts "  cat ${setup_report}"
puts "  cat ${hold_report}"
puts "  cat ${clock_skew_report}"
puts ""
puts "============================================================"

# Exit successfully
exit 0
